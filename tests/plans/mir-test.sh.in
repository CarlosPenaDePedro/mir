:

set -eaux

echo "======> $1"

t=$(basename $1)

mir="@MIR_TOOL@"
mars_script="@MARS_SCRIPT@"

tests_assertions_dir="@CMAKE_CURRENT_SOURCE_DIR@"
tmp_assertions_dir="@CMAKE_CURRENT_BINARY_DIR@"

pwd

state=mars
while read n
do
    if [[ "$n" = "" ]]
    then
        continue
    fi
    echo $n
    case $n in
        \#*)
            ;;

        *)
        case $state in

            mars)
            m=$(echo $n | tr '/' '_')
            if [[ -f "${tests_assertions_dir}/$m" ]]
            then
                ln -sf "${tests_assertions_dir}/$m" data.in.$t
            elif [[ -f "${tmp_assertions_dir}/$m" ]]
            then
                ln -sf "${tmp_assertions_dir}/$m" data.in.$t
            else
                echo "retrieve,$n,target=data.in.$t" > mars.r.$t
                $mars_script mars.r.$t || rm data.in.$t
                cp data.in.$t "${tmp_assertions_dir}/$m"
            fi
            state=mir
            ;;

            mir)
            eval n=\"$n\"
            $mir --dump-plan-file=$(pwd)/plan.$t $n $(pwd)/data.in.$t $(pwd)/data.out.$t
            state=plan
            ;;

            plan)
            m=$(cat $(pwd)/plan.$t)
            if [[ "$n" != "$m" ]]
            then
                echo "Expected: $n"
                echo "     Got: $m"
                exit 1
            fi
            state=done
            ;;

        esac
        ;;


    esac
done < $1

if [[ "$state" != "done" ]]
then
    echo "No plan defined"
    exit 1
fi
